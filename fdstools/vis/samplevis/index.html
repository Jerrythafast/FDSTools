<!DOCTYPE html>
<html>
<head>
    <!--
    # Copyright (C) 2021 Jerry Hoogenboom
    #
    # This file is part of FDSTools, data analysis tools for Massively
    # Parallel Sequencing of forensic DNA markers.
    #
    # FDSTools is free software: you can redistribute it and/or modify it
    # under the terms of the GNU General Public License as published by the
    # Free Software Foundation, either version 3 of the License, or (at
    # your option) any later version.
    #
    # FDSTools is distributed in the hope that it will be useful, but
    # WITHOUT ANY WARRANTY; without even the implied warranty of
    # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    # General Public License for more details.
    #
    # You should have received a copy of the GNU General Public License
    # along with FDSTools.  If not, see <http://www.gnu.org/licenses/>.
    -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sample Visualisation - FDSTools</title>
    <!-- VERSION 2.3.0 -->
    <!-- BEGIN_LIBRARIES -->
    <script src="https://vega.github.io/vega-editor/vendor/d3.min.js"></script>
    <script src="https://vega.github.io/vega/vega.min.js"></script>
    <!-- END_LIBRARIES -->
    <style>
    input {
        font-family: inherit;
        font-size: 1em;
    }
    .icon {
        padding: 0em 1em;
        margin-right: .25em;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
    }
    .icon.warning {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjYwIiBoZWlnaHQ9IjI2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnI\
        j48cGF0aCBmaWxsPSIjZmZjYzAwIiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iNyIgc3Ryb2tlLW1pdGVybGltaXQ9IjQiIGQ9Im0xMy42ODQyNDIsMjEwLjk2MDk\
        wN2MtMS42MzE4MzIsMy4xNDE5ODMgLTMuNTU1MTQzLDYuMDc5NTU5IC0zLjU1NTMyMyw5LjUyNzg2M2wwLjAxNjEyMSwxLjQ0MTIwOGMwLDcuNDQyNDkgNS44MzA5OCwxMS45N\
        DE3MjcgMTIuNTM0NzI3LDExLjk0MTcyN2wyMTYuNjA3NzA4LDBjNi43MDQyODUsMCAxMi40NzgxMTksLTUuNTc3NDIzIDEyLjQ3ODExOSwtMTMuMDE5OTEzbC0wLjA3MTE2Nyw\
        tMS40NDc2MDFjMCwtMy40NDgzMzQgLTEuNjk2NjU1LC02LjQ0MjY3MyAtMy41NTQ3NzksLTkuNTI3OTA4bC0xMDcuMjc0NjczLC0xOTIuMjcwNjM0Yy00LjczOTU3OCwtNS4yN\
        jE3ODQgLTEyLjQyMzUzOCwtNS4yNjE3ODQgLTE3LjE2Mzg0OSwwLjAwMDcxbC0xMTAuMDE2ODg0LDE5My4zNTQ1NDl6Ii8+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0ibTE1MC4\
        1OTc2ODcsMTkxLjc1NDE1YTE3LjA5MTUxNiwxNy4wNzcwMTcgMCAxIDEtMzQuMTgzMDE0LDBhMTcuMDkxNTE2LDE3LjA3NzAxNyAwIDEgMTM0LjE4MzAxNCwweiIvPjxwYXRoI\
        GZpbGw9IiMwMDAwMDAiIGQ9Im0xMzMuMzk0ODgyLDczLjEwNjYxM2M2LjcxNDYsMCAxNy4xMzU0MzcsNS4zNDUyNzYgMTcuMTM1NDM3LDExLjk4NDkwMWwtNS4wMTUyMjgsNjk\
        uMDA0MDA1YzAsNi42Mzk2NDggLTUuNDA1NjA5LDExLjk4NDkyNCAtMTIuMTIwMjA5LDExLjk4NDkyNGMtNi43MTQ2LDAgLTEyLjEyMDE5MywtNS4zNDUyNzYgLTEyLjEyMDE5M\
        ywtMTEuOTg0OTI0bC01Ljg1MTEzNSwtNjkuMDA0MDA1YzAsLTYuNjM5NjI2IDExLjI1NjcyOSwtMTEuOTg0OTAxIDE3Ljk3MTMyOSwtMTEuOTg0OTAxeiIvPjwvc3ZnPg==");
    }
    @media screen {
        html, body {
            /* First the UI fonts of WinVista+, OSX10.11, OSX10.10, OSX10.9-, WinXP-, Ubuntu. Then some fallbacks. */
            font-family: Segoe UI, San Francisco, Helvetica Neue, Lucida Grande, Tahoma, Ubuntu, Helvetica, Arial, sans-serif;
            font-size: 10pt;
        }
        body {
            margin: 0rem;
        }
        a {
            color: inherit;
            text-decoration: inherit;
            border-bottom: 1px dotted;
        }
        a:hover {
            border-bottom: 1px solid;
        }
        a.disabled {
            color: hsl(220, 20%, 53%);
        }
        a.disabled:hover {
            color: hsl(220, 20%, 53%);
            border-bottom: 1px dotted;
            cursor: default;
        }
        #outer {
            display: flex;
            flex-flow: column nowrap;
            height: 100vh;
            overflow: hidden;
        }
        #inner {
            display: flex;
            flex-flow: row nowrap;
            flex: 1 1 auto;
            overflow: hidden;
        }
        #messagebox {
            flex: 0 0 auto;
            background-color: hsl(220, 20%, 77%);
            padding: .2rem;
            max-height: 3.8em;
            overflow: auto;
            cursor: default;
        }
        #optscrollbox {
            display: flex;
            flex-flow: column nowrap;
            flex: 0 0 auto;
            width: 22.5em;
            order: -1;
            overflow: auto;
            background-color: hsl(220, 20%, 77%);
            border-right: 1px solid hsl(220, 20%, 3%);
            border-bottom: none;
            cursor: default;
        }
        #visscrollbox {
            flex: 1 1 auto;
            overflow: auto;
            background-color: hsl(220, 20%, 97%); /* eef8ff */
            border-bottom: 1px solid hsl(220, 20%, 3%);
            text-align: right;
        }
        .optiongroup {
            flex: 0 0 auto;
            padding: .2rem .2rem 1rem;
        }
        .optiongroup:last-child {
            padding: .2rem;
        }
        .optiongroup > table {
            margin: 0rem;
            border-spacing: 0rem;
            border: none;
        }
        .optiongroup > .optionheader {
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
        }
        .optiongroup > .optionheader:first-letter {
            font-size: 1.25em;
        }
        .optiongroup > table td {
            white-space: nowrap;
        }
        .optiongroup > table td:not(:last-child) {
            padding-right: .4rem;
        }
        .optiongroup > table tr.fileselectrow, .optiongroup > table tr.filenamedisplayrow {
            display: none;
        }
        .optiongroup > table tr.filenamedisplayrow #filenamedisplay {
            max-width: 20em;
            width: auto;
        }
        .optiongroup > table td.footnote {
            font-style: italic;
            white-space: wrap;
        }
        .help {
            cursor: help;
            font-weight: bold;
            border-bottom: 1px dotted hsl(220, 20%, 3%);
        }
        #vis {
            direction: rtl;
            display: inline-block;
        }
        #vis div {
            direction: ltr;
        }
        #vis > div:not(:first-child) {
            border-top: 1px solid hsl(220, 20%, 3%);
            padding-top: .8rem;
            margin-top: .8rem;
        }
        #vis > div:last-child {
            padding-bottom: .8rem;
        }
        #vis-tooltip {
            display: none;
            position: fixed;
            z-index: 999999;
            background-color: hsla(220, 20%, 77%, 0.75);
            border: 1px solid hsl(220, 20%, 3%);
            border-radius: .5em;
            padding: 0em .25em .25em;
        }
        .markertable {
            display: inline-table;
            text-align: left;
            border-collapse: collapse;
            max-width: 55vw;
            margin-right: 12rem;
        }
        .tooltiptable {
            border-collapse: collapse;
            margin-top: .25em;
            width: 100%;
            max-width: 30em;
        }
        .markertable td, .tooltiptable td {
            border: 1px solid hsl(220, 20%, 57%);
            padding: .4rem;
            font-size: 0.8em;
            white-space: nowrap;
            width: .1rem;
        }
        .markertable tr:first-child td, .tooltiptable tr:first-child td, .tooltiptable td:first-child {
            background-color: hsl(220, 20%, 77%);
            font-weight: bold;
        }
        .markertable td:nth-child(2), .tooltiptable td:first-child {
            width: auto;
        }
        .markertable tr:nth-child(1n+2), .tooltiptable tr:nth-child(1n+2) {
            background-color: hsl(220, 20%, 97%);
        }
        .markertable tr:nth-child(2n), .tooltiptable tr:nth-child(2n) {
            background-color: hsl(220, 20%, 90%);
        }
        .markertable tr.removed td:not(:last-child), .markertable tr.removed td:not(:last-child) * {
            text-decoration: line-through;
        }
        .tooltiptable tr:first-child td:first-child {
            background-color: transparent;
            border: none;
        }
        td.num {
            text-align: right;
        }
        td.lefthalf {
            text-align: right;
            border-right: none;
            padding-right: 0px;
            margin-right: 0px;
        }
        td.lefthalf+td {
            border-left: none;
            padding-left: 0px;
            margin-left: 0px;
        }
        td.wrap {
            white-space: normal !important;
            width: 1em;
        }
    }
    /*
    portrait, height >= 55:

      small collapsed   large collapsed   small top    large top
    |-----------------|-----------------|------------|------------>  width
    0                 45                60           68


    portrait, height < 55:

      small collapsed   large collapsed
    |-----------------|------------------------------------------->  width
    0                 45


    landscape:

      small collapsed   large collapsed   small left   large left
    |-----------------|-----------------|------------|------------>  width
    0                 45                60           68
    */
    @media only screen and (min-aspect-ratio: 40000/30000) and (min-width: 60em) and (max-width: 68em), /* Full menu is at the side, but viewport is not very wide */
           only screen and (max-aspect-ratio: 40000/30000) and (min-height: 55em) and (min-width: 60em) and (max-width: 68em), /* Full menus at the top, but viewport not wide enough */
           only screen and (max-width: 45em) { /* Very narrow; menu names don't fit anymore */
        /* Limited width: make menu smaller */
        #optscrollbox {
            font-size: .85em;
        }
    }
    @media only screen and (max-aspect-ratio: 40000/30000), only screen and (max-width: 60em) {
        /* Portrait or near-portrait, or rather narrow: menu at the top */
        #inner {
            flex-direction: column;
        }
        #optscrollbox {
            flex: 0 0 auto;
            flex-flow: row nowrap;
            width: 100%;
            border-right: none;
            border-bottom: 1px solid hsl(220, 20%, 3%);
        }
        #visscrollbox {
            flex: 1 1 auto;
        }
        .optiongroup {
            flex: 1 0 auto;
            padding: .2rem 1rem .2rem .2rem;
        }
        .markertable {
            max-width: 90vw;
        }
    }
    @media only screen and (max-aspect-ratio: 40000/30000) and (max-height: 55em), only screen and (max-width: 60em) {
        /* Portrait or near-portrait combined with very limited height, or rather narrow: collapse menu */
        #optscrollbox {
            overflow: visible;
            z-index: 100;
            border-bottom: 1px solid hsl(220, 20%, 3%);
        }
        .optiongroup {
            position: relative;
        }
        .optiongroup > table {
            display: none;
            position: absolute;
            top: 100%;
            background-color: hsl(220, 20%, 77%);
            border: 1px solid hsl(220, 20%, 3%);
            border-top: none;
        }
        .optiongroup:last-child > table {
            left: auto;
            right: .2rem;
        }
        .optiongroup:hover > .optionheader {
            color: hsl(220, 20%, 97%);
        }
        .optiongroup:hover > table {
            display: table;
        }
    }

    @media print {
        html, body {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 10pt;
        }
        .noprint, .help {
            display: none;
        }
        #messagebox {
            font-size: 8pt;
            padding: 5pt 0pt;
        }
        #optscrollbox {
            display: flex;
            box-sizing: border-box;
            flex-flow: row wrap;
            align-items: stretch;
            width: 100%;
            border-top: 1pt solid black;
            border-right: 1pt solid black;
            font-size: 7pt;
        }
        .optiongroup {
            flex-grow: 1;
            padding: 5pt;
            border-left: 1pt solid black;
            border-bottom: 1pt solid black;
        }
        .optiongroup > table {
            padding: 0px;
            margin: 0px;
            border-spacing: 0px;
            border: none;
        }
        .optiongroup > .optionheader {
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
        }
        .optiongroup > .optionheader:first-letter {
            font-size: 1.25em;
        }
        .optiongroup > table td {
            white-space: nowrap;
        }
        .optiongroup > table td:not(:last-child) {
            padding-right: 5pt;
        }
        .optiongroup > table td.footnote {
            font-style: italic;
            white-space: wrap;
        }
        .optiongroup > table input {
            border: none;
        }
        .optiongroup > table input[type=checkbox] {
            height: 1em;
            width: 1em;
        }
        #vis {
            width: 100%;
        }
        #vis > div {
            width: 100%;
            direction: rtl;
            text-align: right;
        }
        #vis > div > * {
            direction: ltr;
        }
        #vis > div {
            page-break-inside: avoid;
        }
        #vis-tooltip {
            display: none;
        }
        .vega, canvas {
            max-width: 100%;
            height: auto;
            overflow: visible;
        }
        svg {
            /* Using slightly smaller width to prevent clipping in Chrome */
            max-width: 98%;
            height: auto;
            overflow: visible;
        }
        canvas {
            object-fit: scale-down;
        }
        .markertable {
            display: inline-table;
            box-sizing: border-box;
            text-align: left;
            border-collapse: collapse;
            min-width: 100% !important;
        }
        .markertable td {
            border: 1pt solid #888888;
            padding: 2pt;
            font-size: 7pt;
            white-space: nowrap;
            width: 40pt;
        }
        .markertable tr:first-child td {
            font-weight: bold;
        }
        .markertable td:nth-child(2) {
            width: auto;
        }
        .markertable tr:first-child {
            background-color: #cccccc;
        }
        .markertable tr:nth-child(2n) {
            background-color: #eeeeee;
        }
        .markertable tr.removed td:not(:last-child), .markertable tr.removed td:not(:last-child) * {
            text-decoration: line-through;
        }
        .num {
            text-align: right;
        }
        td.lefthalf {
            text-align: right;
            border-right: none;
            padding-right: 0px;
            margin-right: 0px;
        }
        td.lefthalf+td {
            border-left: none;
            padding-left: 0px;
            margin-left: 0px;
            width: 1em !important;
        }
        td.wrap {
            white-space: normal !important;
        }
    }
    </style>
</head>
<body>
<div id="outer">
<div id="inner">
    <div id="optscrollbox">
        <div class="optiongroup noprint">
            <div class="optionheader">Input &amp; output</div>
            <table>
                <tr class="fileselectrow filenamedisplayrow">
                    <td>Sample data file:</td>
                </tr>
                <tr class="fileselectrow">
                    <td><input id="fileselect" type="file"></td>
                </tr>
                <tr class="fileselectrow">
                    <td>(or drag a file onto this page)</td>
                </tr>
                <tr class="filenamedisplayrow">
                    <td id="filenamedisplay" class="wrap"></td>
                </tr>
                <tr>
                    <td>
                        <a id="saveImageLink" href="javascript:void(saveImage())" class="disabled">Save image</a>
                        <a id="saveTableLink" href="javascript:void(saveTable())" class="disabled">Save table</a>
                        <a id="savePageLink" href="javascript:void(savePage())" class="disabled">Save page</a>
                    </td>
                </tr>
            </table>
        </div>
        <div class="optiongroup">
            <div class="optionheader">Graph filtering options</div>
            <table>
                <tr>
                    <td colspan="2">Show sequences with at least:</td>
                </tr>
                <tr>
                    <td colspan="2"><label><input type="text" value="5" id="minN" size="3" class="num"> reads</label></td>
                </tr>
                <tr>
                    <td colspan="2"><label><input type="text" value="0.5" id="minP" size="3" class="num">% of highest allele per marker</label></td>
                </tr>
                <tr>
                    <td colspan="2"><label><input type="text" value="0" id="minT" size="3" class="num">% of the marker's total reads</label></td>
                </tr>
                <tr>
                    <td colspan="2"><label><input type="text" value="0" id="minO" size="3" class="num"> reads in both orientations</label></td>
                </tr>
                <tr>
                    <td><label for="markerFilter">Marker(s)</label></td>
                    <td>
                        <label>
                            <input type="text" id="markerFilter" size="15">
                            <span class="help" title="Type xyz to show all markers with 'xyz' in their names. Type =xyz to show only the marker 'xyz'. Separate multiple values with spaces.">?</span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td><label for="minBias">Mark with &lt;</label></td>
                    <td><label><input type="text" value="0" id="minBias" size="3" class="num">% of reads on one strand</label></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="shownegative" checked>
                            Show negative alleles
                        </label>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="filteruncorrected" checked>
                            Filter before noise correction
                        </label>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="showother" checked>
                            Show filtered data as 'Other sequences'
                        </label>
                    </td>
                </tr>
            </table>
        </div>
        <div class="optiongroup">
            <div class="optionheader">Table filtering options</div>
            <table>
                <tr>
                    <td>Select sequences having at least:</td>
                </tr>
                <tr>
                    <td><label><input type="text" value="30" id="minNa" size="3" class="num"> reads</label></td>
                </tr>
                <tr>
                    <td><label><input type="text" value="2" id="minPa" size="3" class="num">% of highest allele per marker</label></td>
                </tr>
                <tr>
                    <td><label><input type="text" value="1.5" id="minTa" size="3" class="num">% of the marker's total reads</label></td>
                </tr>
                <tr>
                    <td><label><input type="text" value="0" id="minCa" size="3" class="num">% correction*</label></td>
                </tr>
                <tr>
                    <td><label><input type="text" value="0" id="minAa" size="3" class="num">% recovery*</label></td>
                </tr>
                <tr>
                    <td><label><input type="text" value="0" id="minOa" size="3" class="num"> reads in both orientations</label></td>
                </tr>
                <tr>
                    <td class="footnote">*Of these criteria, at least one must be met</td>
                </tr>
                <tr class="noprint">
                    <td><a id="clearSelectionLink" href="javascript:void(clearSelection())" class="disabled">Clear manually added/removed</a></td>
                </tr>
            </table>
        </div>
        <div class="optiongroup noprint">
            <div class="optionheader">Display options</div>
            <table>
                <tr>
                    <td><label for="graphwidth">Graph width</label></td>
                    <td><label><input type="text" value="600" id="graphwidth" size="3" class="num"> px</label></td>
                </tr>
                <tr>
                    <td><label for="barwidth">Bar width</label></td>
                    <td><label><input type="text" value="15" id="barwidth" size="3" class="num"> px</label></td>
                </tr>
                <tr>
                    <td><label for="subgraphoffset">Marker spacing</label></td>
                    <td><label><input type="text" value="70" id="subgraphoffset" size="3" class="num"> px</label></td>
                </tr>
                <tr>
                    <td><label for="maxseqlen">Truncate sequences to</label></td>
                    <td><label><input type="text" value="70" id="maxseqlen" size="3" class="num"> characters</label></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="splitmarkers" checked>
                            Split markers
                        </label>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="commonrange" disabled>
                            Common axis range
                            <span class="help" title="This option is only available if 'Split markers' has been turned off.">?</span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label>
                            <input type="checkbox" id="sortstrbylength">
                            Sort STR alleles by length
                        </label>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <table>
                            <tr>
                                <td>Axis scale</td>
                                <td><label><input type="radio" name="scale" value="linear" id="scaleLinear" checked> Linear</label></td>
                                <td><label><input type="radio" name="scale" value="sqrt" id="scaleLog"> Square root</label></td>
                            </tr>
                            <tr class="noprint">
                                <td>Renderer</td>
                                <td><label><input type="radio" name="renderer" value="svg" id="renderSVG" checked> SVG</label></td>
                                <td><label><input type="radio" name="renderer" value="canvas" id="renderCanvas"> Canvas</label></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="visscrollbox">
        <div id="vis"></div>
    </div>
</div>
<div id="messagebox">
    Ready
</div>
</div>
<div id="vis-tooltip"></div>
<script type="text/javascript">
var PAT_LOAD_SCRIPT = /(<!--\s*BEGIN_LOAD_SCRIPT\s*-->\s*)([^]*?\s*<\/script>)/;
var PAT_SEQ_RAW = /^[ACGT]*$/;
var PAT_ALLELENAME_SPLIT = /[\]\)_]/g;
var graphs = false;
var linebreak = "\n";
var data_format = {};
var data_values = [];
var missing_markers = [];
var fileName = "sample";
var stamp = 0;
var userSelected = [];
var userDeselected = [];
var autoSelected = [];
var selectedAlleles = []; //This keeps the alleles of filtered markers in a safe place.
var isAutoselecting = false;
function parse(maintainSelection){
    if(maintainSelection)
        selectedAlleles = selectedAlleles.concat(userSelected, userDeselected, userDeselected);
    else
        selectedAlleles = [];
    userSelected = [];
    userDeselected = [];
    autoSelected = [];
    var this_stamp = ++stamp;
    var visdiv = document.getElementById("vis");
    var scrolldiv = document.getElementById("visscrollbox");
    var rendererName = document.querySelector("input[name=renderer]:checked").value;
    graphs = [];
    removeChildren(visdiv);
    document.getElementById("saveImageLink").setAttribute("class", "disabled");
    document.getElementById("saveTableLink").setAttribute("class", "disabled");
    document.getElementById("clearSelectionLink").setAttribute("class", selectedAlleles.length? "" : "disabled");
    document.getElementById("savePageLink").setAttribute("class", "");

    //Get a list of marker names and render a graph for each of them.
    var splitMarkers = document.getElementById("splitmarkers").checked;
    var markerFilter = document.getElementById("markerFilter").value;
    var markerNames = [];
    var patt;
    try{
        patt = compileFilter(markerFilter.trim());
    }
    catch(e){
        patt = new RegExp('(?:^$)');
        markerFilter = "=";
    }
    if(splitMarkers)
        data_values.forEach(function(datum){
            if(patt.test(datum.marker))
                markerNames.push("=" + datum.marker);
        });
    else
        markerNames.push(markerFilter);
    var prevMarker;
    markerNames.sort().forEach(function(marker){
        if(marker != prevMarker)
            prevMarker = marker;
        else
            return;

        //Set up graph spec for this marker.
        for(i in graph_spec.signals)
            if(graph_spec.signals[i].name == "filter_marker")
                graph_spec.signals[i].init = marker;
        var patt = compileFilter(marker);
        graph_spec.data[0].values = data_values.filter(function(datum){return patt.test(datum.marker)});

        //Render graph for this marker.
        vg.parse.spec(graph_spec, function(chart){
            //Cancel rendering if a new parse() call was made.
            if(this_stamp != stamp)
                return;

            var i = graphs.length;

            //Add new visualisation and table divs.
            var visouter = document.createElement("div");
            var newvis = document.createElement("div");
            newvis.setAttribute("id", "vis" + i);
            visouter.appendChild(newvis);
            var newtab = document.createElement("div");
            newtab.setAttribute("id", "tab" + i);
            visouter.appendChild(newtab);
            visdiv.appendChild(visouter);

            var graph = chart({el: newvis, renderer: rendererName});
            graph.onSignal("clickedAllele", function(name, value){
                if(isAutoselecting)
                    return;
                document.getElementById("clearSelectionLink").setAttribute("class", "");
                if(graph.data("selectedAlleles").values().some(function(item){return item.thedatum==value})){
                    //User added this allele.
                    var pos = userDeselected.indexOf(value);
                    if(pos >= 0)
                        userDeselected.splice(pos, 1);
                    if(userSelected.indexOf(value) == -1)
                        userSelected.push(value);
                }
                else{
                    //User removed this allele.
                    var pos = userSelected.indexOf(value);
                    if(pos >= 0)
                        userSelected.splice(pos, 1);
                    if(userDeselected.indexOf(value) == -1)
                        userDeselected.push(value);
                }
                updateTable(i);
            });
            graph.onSignal("bias_threshold", function(){updateTable(i)});
            graph.onSignal("hovered", function(s, datum){
                var tt = document.getElementById("vis-tooltip");
                if(!datum){
                    tt.style.display = "none";
                    return;
                }
                tt.style.display = "block";
                removeChildren(tt);
                var b = document.createElement("b");
                b.appendChild(document.createTextNode(datum.marker + " "));
                appendChunkedAllelename(b, datum.sequence);
                tt.appendChild(b);
                var table = document.createElement("table");
                table.setAttribute("class", "tooltiptable");
                var row = table.insertRow();
                row.insertCell();
                var cell = row.insertCell();
                cell.appendChild(document.createTextNode("Reads"));
                cell.setAttribute("class", "num");
                cell.setAttribute("colspan", "2");
                cell = row.insertCell();
                cell.appendChild(document.createTextNode("Correction"));
                cell.setAttribute("class", "num");
                cell.setAttribute("colspan", "2");
                cell = row.insertCell();
                cell.appendChild(document.createTextNode("Recovery"));
                cell.setAttribute("class", "num");
                cell.setAttribute("colspan", "2");
                cell = row.insertCell();
                cell.appendChild(document.createTextNode("Noise"));
                cell.setAttribute("class", "num");
                cell.setAttribute("colspan", "2");
                row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("Total"));
                row.insertCell().appendChild(document.createTextNode(
                        datum.total == datum.total_added? " " : (datum.total.toFixed() + " \u2192\u00a0")
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.total_added.toFixed()
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        (datum.total_added < datum.total? "" : "+") + (datum.total_added-datum.total).toFixed()
                    )).parentNode.setAttribute("class", "lefthalf");
                var corrAmount = datum.total_added/datum.total*100-100;
                row.insertCell().appendChild(document.createTextNode(
                        datum.total? (
                            "\u00a0(" + (corrAmount < 0? "" : "+") + corrAmount.toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.total_add? datum.total_add.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.total_added? (
                            "\u00a0(" + (datum.total_add/datum.total_added*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.total_noise? datum.total_noise.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.total? (
                            "\u00a0(" + (datum.total_noise/datum.total*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("Forward"));
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(
                        datum.forward == datum.forward_added? " " : (datum.forward.toFixed() + " \u2192\u00a0")
                    ));
                cell.setAttribute("class", "lefthalf");
                if(datum.biasmark !== "" && datum.forward_added < datum.reverse_added)
                    cell.style.backgroundColor = "#ffaaaa";
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(
                        datum.forward_added.toFixed()
                    ));
                cell.setAttribute("class", "num");
                if(datum.biasmark !== "" && datum.forward_added < datum.reverse_added)
                    cell.style.backgroundColor = "#ffaaaa";
                row.insertCell().appendChild(document.createTextNode(
                        (datum.forward_added < datum.forward? "" : "+") + (datum.forward_added-datum.forward).toFixed()
                    )).parentNode.setAttribute("class", "lefthalf");
                corrAmount = datum.forward_added/datum.forward*100-100;
                row.insertCell().appendChild(document.createTextNode(
                        datum.forward? (
                            "\u00a0(" + (corrAmount < 0? "" : "+") + corrAmount.toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.forward_add? datum.forward_add.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.forward_added? (
                            "\u00a0(" + (datum.forward_add/datum.forward_added*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.forward_noise? datum.forward_noise.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.forward? (
                            "\u00a0(" + (datum.forward_noise/datum.forward*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("Reverse"));
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(
                        datum.reverse == datum.reverse_added? " " : (datum.reverse.toFixed() + " \u2192\u00a0")
                    ));
                cell.setAttribute("class", "lefthalf");
                if(datum.biasmark !== "" && datum.forward_added > datum.reverse_added)
                    cell.style.backgroundColor = "#ffaaaa";
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(
                        datum.reverse_added.toFixed()
                    ));
                cell.setAttribute("class", "num");
                if(datum.biasmark !== "" && datum.forward_added > datum.reverse_added)
                    cell.style.backgroundColor = "#ffaaaa";
                row.insertCell().appendChild(document.createTextNode(
                       (datum.reverse_added < datum.reverse? "" : "+") + (datum.reverse_added-datum.reverse).toFixed()
                    )).parentNode.setAttribute("class", "lefthalf");
                corrAmount = datum.reverse_added/datum.reverse*100-100;
                row.insertCell().appendChild(document.createTextNode(
                        datum.reverse? (
                            "\u00a0(" + (corrAmount < 0? "" : "+") + corrAmount.toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.reverse_add? datum.reverse_add.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.reverse_added? (
                            "\u00a0(" + (datum.reverse_add/datum.reverse_added*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row.insertCell().appendChild(document.createTextNode(
                        datum.reverse_noise? datum.reverse_noise.toFixed() : "0"
                    )).parentNode.setAttribute("class", "lefthalf");
                row.insertCell().appendChild(document.createTextNode(
                        datum.reverse? (
                            "\u00a0(" + (datum.reverse_noise/datum.reverse*100).toFixed(2) + "%)"
                        ) : ""
                    )).parentNode.setAttribute("class", "num");
                row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("PctOfHighest"));
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(datum.pct_of_max.toFixed(2) + "%"));
                cell.setAttribute("colspan", "8");
                row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("PctOfMarker"));
                cell = row.insertCell();
                cell.appendChild(document.createTextNode(datum.pct_of_sum.toFixed(2) + "%"));
                cell.setAttribute("colspan", "8");
                if(datum.new_allele == "*"){
                    row = table.insertRow();
                    cell = row.insertCell();
                    cell.appendChild(document.createTextNode("New allele"));
                    cell = row.insertCell();
                    cell.appendChild(document.createTextNode("Yes"));
                    cell.setAttribute("colspan", "8");
                    cell.style.backgroundColor = "#ffe8c8";
                }
                tt.appendChild(table);
            });
            graph.update();
            if(rendererName == "svg")
                updateViewBox(graph._el.childNodes[0]);
            graphs.push(graph);
            if(!splitMarkers)
                document.getElementById("saveImageLink").setAttribute("class", "");

            //Restore selected and deselected alleles. Deselected alleles
            //are the ones that appear in selectedAlleles twice.
            var graphAlleles = graph.data("annotated").values();
            selectedAlleles = selectedAlleles.filter(function(sa){
                return graphAlleles.every(function(datum){
                    var prev = datum._prev;
                    sa._prev = null;
                    datum._prev = null;
                    sa._id = datum._id;
                    sa.aggrm._id = datum.aggrm._id;
                    sa.aggrs._id = datum.aggrs._id;
                    sa.rank = datum.rank;
                    sa.thedatum = null;
                    datum.thedatum = null;
                    var equal = vg.util.equal(sa, datum);
                    datum.thedatum = datum;
                    if(prev)
                        datum._prev = prev;
                    if(equal)
                        graph.signal("clickedAllele", datum).update();
                    return !equal;
                });
            });

            //Automatically select alleles using set thresholds.
            autoSelectAlleles(graph);

            //Scroll to the right; the graph is more interesting than the long labels.
            scrolldiv.scrollLeft = scrolldiv.scrollWidth;
        });
    });
    if(missing_markers.length)
        setMessage("Warning: Some markers were not detected in this sample:\n" + missing_markers.join(", "), true, "warning");
}

function appendChunkedAllelename(parent, allele){
    var span;
    if(PAT_SEQ_RAW.test(allele)){
        span = document.createElement("span");
        span.style.display = "inline-block";
        span.style.wordBreak = "break-all";
        span.appendChild(document.createTextNode(allele));
        parent.appendChild(span);
        return;
    }
    var match;
    var pos = 0;
    while((match = PAT_ALLELENAME_SPLIT.exec(allele)) !== null){
        span = document.createElement("span");
        span.style.display = "inline-block";
        span.style.whiteSpace = "nowrap";
        span.appendChild(document.createTextNode(allele.substring(pos, match.index+1)));
        parent.appendChild(span);
        pos = match.index+1;
    }
    if(pos < allele.length){
        span = document.createElement("span");
        span.style.display = "inline-block";
        span.style.whiteSpace = "nowrap";
        span.appendChild(document.createTextNode(allele.substring(pos)));
        parent.appendChild(span);
    }
}

function compileFilter(filter){
    return new RegExp('(?:' + filter.replace(/(^| )=(.*?)(?= |$)/g, '$1^$2$$').replace(/ +/g, ')|(?:') + ')')
}

function setMessage(message, printed, messagetype){
    var messagebox = document.getElementById("messagebox");
    removeChildren(messagebox);
    messagebox.setAttribute("class", printed? "" : "noprint");

    if(messagetype == "warning"){
        var icon = document.createElement("span");
        icon.setAttribute("class", "icon warning");
        messagebox.appendChild(icon);
    }

    messagebox.appendChild(document.createTextNode(message));
}

function autoSelectAlleles(graph){
    if(graphs === false)
        return;
    var minNa = parseFloat(document.getElementById("minNa").value),
        minPa = parseFloat(document.getElementById("minPa").value),
        minTa = parseFloat(document.getElementById("minTa").value),
        minCa = parseFloat(document.getElementById("minCa").value),
        minAa = parseFloat(document.getElementById("minAa").value),
        minOa = parseFloat(document.getElementById("minOa").value);
    if(isNaN(minNa + minPa + minTa + minCa + minAa + minOa))
        return;
    (graph === undefined? graphs : [graph]).forEach(function(graph){
        var selectedAllelesInGraph = graph.data("selectedAlleles").values().map(function(datum){return datum.thedatum});
        graph.data("annotated").values().forEach(function(datum){
            if(datum.sequence != "Other sequences" &&
               datum.total_added >= minNa &&
               datum.pct_of_max >= minPa &&
               datum.pct_of_sum >= minTa &&
               ((datum.total_added/datum.total*100-100) >= minCa ||
               (datum.total_add/datum.total_added*100) >= minAa) &&
               Math.min(datum.forward_added, datum.reverse_added) >= minOa){
                if(autoSelected.indexOf(datum) == -1)
                    autoSelected.push(datum);
                if(selectedAllelesInGraph.indexOf(datum) == -1 && userDeselected.indexOf(datum) == -1){
                    //Meets criteria, not selected, and user has not deselected. Autoselect.
                    isAutoselecting = true;
                    graph.signal("clickedAllele", datum).update();
                    isAutoselecting = false;
                }
            }
            else{
                var pos = autoSelected.indexOf(datum);
                if(pos >= 0)
                    autoSelected.splice(pos, 1);
                if(selectedAllelesInGraph.indexOf(datum) >= 0 && userSelected.indexOf(datum) == -1){
                    //Does not meet criteria but was autoselected previously. Autodeselect.
                    isAutoselecting = true;
                    graph.signal("clickedAllele", datum).update();
                    isAutoselecting = false;
                }
            }
        });
        updateTable(graphs.indexOf(graph));
    });
}

function updateViewBox(svg){
    //Setting the viewBox enables shrink-to-fit behaviour when printing.
    svg.setAttribute("viewBox",
        "0 0 " + svg.getAttribute("width") + " " + svg.getAttribute("height"));
}

function removeChildren(el){
    while(el.lastChild){
      el.removeChild(el.lastChild);
    }
}

function setScale(value){
    if(!graph_spec)
        return;
    for(i in graph_spec.marks)
        if(graph_spec.marks[i].scales)
            for(j in graph_spec.marks[i].scales)
                if(graph_spec.marks[i].scales[j].name == "x")
                    graph_spec.marks[i].scales[j].type = value;

    if(graphs !== false)
        parse(true);
}

function getScale(){
    if(!graph_spec)
        return "linear";
    for(i in graph_spec.marks)
        if(graph_spec.marks[i].scales)
            for(j in graph_spec.marks[i].scales)
                if(graph_spec.marks[i].scales[j].name == "x")
                    return graph_spec.marks[i].scales[j].type;
    return "linear";
}

function setSignalValue(signalname, value){
    if(!graph_spec)
        return;
    var scrolldiv = document.getElementById("visscrollbox");
    var scrollRight = (scrolldiv.scrollLeft >= scrolldiv.scrollWidth - scrolldiv.clientWidth);
    if(signalname == "width")
        graph_spec.width = value;
    for(i in graph_spec.signals){
        if(graph_spec.signals[i].name == signalname){
            graph_spec.signals[i].init = value;
            break;
        }
    }
    if(graphs !== false)
        graphs.forEach(function(graph, i){
            graph.signal(signalname, value).padding("auto").update();
            if(document.getElementById("renderSVG").checked)
                updateViewBox(graph._el.childNodes[0]);
            if(signalname == "width"){
                var tab = document.getElementById("table" + i);
                if(tab)
                    tab.style.minWidth = value + "px";
            }
        });
    if(scrollRight)
        scrolldiv.scrollLeft = scrolldiv.scrollWidth;
    return;
}

function getSignalValue(signalname){
    if(!graph_spec)
        return false;
    if(signalname == "width")
        return graph_spec.width;
    for(i in graph_spec.signals)
        if(graph_spec.signals[i].name == signalname)
            return graph_spec.signals[i].init;
    return false;
}

function setRenderer(value){
    if(graphs !== false)
        graphs.forEach(function(graph){
            graph.renderer(value).update();
            if(value == "svg")
                updateViewBox(graph._el.childNodes[0]);
        });
}

function setFileName(value){
    if(!value)
        value = "sample";
    fileName = value;
    if(value == "sample")
        document.title = "Sample Visualisation - FDSTools";
    else
        document.title = value + " - Sample Visualisation - FDSTools";
}

//Load the data (input is a fileList object; only the first file is loaded).
var currentlyLoadedFile = "no/file/loaded";
function loadDataset(fileList){
    if(!graph_spec || !fileList || !fileList.length || fileList[0].name == currentlyLoadedFile)
        return;
    setMessage("Loading data file...", false);
    currentlyLoadedFile = fileList[0].name;
    var reader = new FileReader();
    reader.onload = function(e){
        if(fileList && fileList.length && fileList[0].name)
            setFileName(fileList[0].name.substr(0, fileList[0].name.lastIndexOf(".")));
        else
            setFileName(false);
        missing_markers = []
        data_values = vg.util.read(reader.result, data_format).filter(function(datum){
            if(datum.sequence == "No data"){
                missing_markers.push(datum.marker);
                return false;
            }
            return true;
        });
        linebreak = reader.result.match(/\r\n|\r|\n/) || linebreak;
        setMessage("Ready", false);
        parse();
    };
    reader.readAsText(fileList[0]);
}

//Clear user selection.
function clearSelection(){
    var link = document.getElementById("clearSelectionLink");
    if(link.getAttribute("class") == "disabled")
        return false;
    graphs.forEach(function(graph){
        graph.data("selectedAlleles").remove(function(){return true});
        graph.update();
    });
    userSelected = [];
    userDeselected = [];
    selectedAlleles = [];
    autoSelectAlleles();
    link.setAttribute("class", "disabled");
}

//Save image function.
function saveImage(){
    var link = document.getElementById("saveImageLink");
    if(link.getAttribute("class") == "disabled")
        return false;
    var imageType = document.getElementById("renderSVG").checked? "svg": "png";
    if(window.navigator.msSaveOrOpenBlob){
        //Internet Explorer has its own ways of doing things.
        var b;
        if(imageType == "svg")
            b = new Blob([graphs[0]._el.innerHTML], {type: "image/svg+xml;charset=utf-8"});
        else
            b = graphs[0]._el.firstChild.msToBlob();
        window.navigator.msSaveOrOpenBlob(b, fileName + "." + imageType);
        if(b.msClose)
            b.msClose();
    }
    else{
        link.setAttribute("href", graphs[0].toImageURL(imageType));
        link.setAttribute("download", fileName + "." + imageType);
        link.click();
        link.setAttribute("href", "javascript:void(saveImage())");
        link.removeAttribute("download");
    }
    return false;
}

//Save table function.
function saveTable(){
    var link = document.getElementById("saveTableLink");
    if(link.getAttribute("class") == "disabled")
        return false;
    var b = new Blob(
        [["marker", "sequence", "reads", "PctOfHighest", "PctOfMarker", "PctCorrected", "PctRecovery", "PctForward", "Notes"].join("\t") + linebreak +
            autoSelected.concat(userSelected).filter(function(datum, index, self){
                return self.indexOf(datum) === index; //Deduplication.
            }).sort(function(a, b){
                return a.rank - b.rank;
            }).map(function(datum){
                var notes = [];
                if(autoSelected.indexOf(datum) >= 0 && userDeselected.indexOf(datum) >= 0)
                    notes.push("user_removed");
                if(autoSelected.indexOf(datum) < 0 && userSelected.indexOf(datum) >= 0)
                    notes.push("user_added");
                if(datum.correction_flags)
                        notes.push.apply(notes, datum.correction_flags.split(",").map(function(x){
                            return x.trim();
                        }));
                if(datum.flags)
                    notes.push.apply(notes, datum.flags.split(",").map(function(x){
                        return x.trim();
                    }));
                return [
                    datum.marker,
                    datum.sequence,
                    datum.total_added.toFixed(),
                    datum.pct_of_max.toFixed(2),
                    datum.pct_of_sum.toFixed(2),
                    (datum.total_added/datum.total*100-100).toFixed(2),
                    (datum.total_add/datum.total_added*100).toFixed(2),
                    datum.forwardpct.toFixed(2),
                    notes.join(",")].join("\t");
            }).join(linebreak)
        ],
        {type: "text/plain"});
    if(window.navigator.msSaveOrOpenBlob)
        window.navigator.msSaveOrOpenBlob(b, fileName + ".csv");
    else{
        var url = URL.createObjectURL(b);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName + ".csv");
        link.click();
        link.setAttribute("href", "javascript:void(saveTable())");
        link.removeAttribute("download");
    }
    if(b.msClose)
        b.msClose();
    return false;
}

//Data table update function.
function updateAllTables(){
    if(graphs === false)
        return;
    graphs.forEach(function(graph, i){updateTable(i)});
}
function updateTable(i){
    if(graphs === false)
        return;
    var table = document.createElement("table");
    table.setAttribute("id", "table" + i);
    table.setAttribute("class", "markertable");
    table.style.minWidth = graphs[i].signal("width") + "px";
    var row = table.insertRow();
    var cell;
    row.insertCell().appendChild(document.createTextNode("Marker"));
    row.insertCell().appendChild(document.createTextNode("Allele"));
    cell = row.insertCell();
    cell.appendChild(document.createTextNode("Reads"));
    cell.setAttribute("class", "num");
    cell.setAttribute("colspan", "2");
    row.insertCell().appendChild(document.createTextNode("PctOfHighest")).parentNode.setAttribute("class", "num");
    row.insertCell().appendChild(document.createTextNode("PctOfMarker")).parentNode.setAttribute("class", "num");
    cell = row.insertCell();
    cell.appendChild(document.createTextNode("Correction"));
    cell.setAttribute("class", "num");
    cell.setAttribute("colspan", "2");
    cell = row.insertCell();
    cell.appendChild(document.createTextNode("Recovery"));
    cell.setAttribute("class", "num");
    cell.setAttribute("colspan", "2");
    cell = row.insertCell();
    cell.appendChild(document.createTextNode("Noise"));
    cell.setAttribute("class", "num");
    cell.setAttribute("colspan", "2");
    row.insertCell().appendChild(document.createTextNode("PctForward")).parentNode.setAttribute("class", "num");
    row.insertCell().appendChild(document.createTextNode("Notes"));

    var graphAlleles = graphs[i].data("annotated").values();
    autoSelected.concat(userSelected).filter(function(datum, index, self){
        return graphAlleles.indexOf(datum) >= 0 && self.indexOf(datum) === index;
    }).sort(function(a, b){
        return a.rank - b.rank;
    }).forEach(function(datum){
        row = table.insertRow();
        row.insertCell().appendChild(document.createTextNode(datum.marker));
        cell = row.insertCell();
        cell.setAttribute("class", "wrap");
        appendChunkedAllelename(cell, datum.sequence);
        row.insertCell().appendChild(document.createTextNode(
                datum.total == datum.total_added? " " : (datum.total.toFixed() + " \u2192\u00a0")
            )).parentNode.setAttribute("class", "lefthalf");
        row.insertCell().appendChild(document.createTextNode(
                datum.total_added.toFixed()
            )).parentNode.setAttribute("class", "num");
        row.insertCell().appendChild(document.createTextNode(datum.pct_of_max.toFixed(2) + "%")).parentNode.setAttribute("class", "num");
        row.insertCell().appendChild(document.createTextNode(datum.pct_of_sum.toFixed(2) + "%")).parentNode.setAttribute("class", "num");
        row.insertCell().appendChild(document.createTextNode(
                (datum.total_added < datum.total? "" : "+") + (datum.total_added-datum.total).toFixed()
            )).parentNode.setAttribute("class", "lefthalf");
        var corrAmount = datum.total_added/datum.total*100-100;
        row.insertCell().appendChild(document.createTextNode(
                datum.total? (
                    "\u00a0(" + (corrAmount < 0? "" : "+") + corrAmount.toFixed(2) + "%)"
                ) : ""
            )).parentNode.setAttribute("class", "num");
        row.insertCell().appendChild(document.createTextNode(
                datum.total_add? datum.total_add.toFixed() : "0"
            )).parentNode.setAttribute("class", "lefthalf");
        row.insertCell().appendChild(document.createTextNode(
                datum.total_added? (
                    "\u00a0(" + (datum.total_add/datum.total_added*100).toFixed(2) + "%)"
                ) : ""
            )).parentNode.setAttribute("class", "num");
        row.insertCell().appendChild(document.createTextNode(
                datum.total_noise? datum.total_noise.toFixed() : "0"
            )).parentNode.setAttribute("class", "lefthalf");
        row.insertCell().appendChild(document.createTextNode(
                datum.total? (
                    "\u00a0(" + (datum.total_noise/datum.total*100).toFixed(2) + "%)"
                ) : ""
            )).parentNode.setAttribute("class", "num");
        cell = row.insertCell();
        cell.appendChild(document.createTextNode(datum.forwardpct.toFixed(2) + "%"));
        cell.setAttribute("class", "num");
        if(datum.biasmark !== "")
            cell.style.backgroundColor = "#ffaaaa";
        cell = row.insertCell();
        var notes = [];
        if(autoSelected.indexOf(datum) >= 0 && userDeselected.indexOf(datum) >= 0){
            notes.push("User-removed");
            row.setAttribute("class", "removed");
        }
        if(autoSelected.indexOf(datum) < 0 && userSelected.indexOf(datum) >= 0)
            notes.push("User-added");
        var warn = 0;
        if(datum.correction_flags){
            datum.correction_flags.split(",").map(function(flag){
                return flag.trim();
            }).forEach(function(flag){
                if(flag == "corrected_bgestimate"){
                    notes.push("BGCorrect-BGEstimate");
                    warn |= 1;
                }
                else if(flag == "corrected_bghomstats"){
                    notes.push("BGCorrect-BGHomStats");
                    warn |= 1;
                }
                else if(flag == "corrected_bgpredict"){
                    notes.push("BGCorrect-BGPredict");
                    warn |= 2;
                }
                else if(flag == "corrected_as_background_only"){
                    notes.push("BGCorrect-as-background-only");
                    warn |= 2;
                }
                else if(flag == "not_in_ref_db"){
                    notes.push("BGCorrect-not-in-ref-db");
                    warn |= 2;
                }
                else if(flag == "not_corrected"){
                    notes.push("BGCorrect-not-corrected");
                    warn |= 2;
                }
                else
                    notes.push(flag);
            });
        }
        if(datum.flags){
            datum.flags.split(",").map(function(flag){
                return flag.trim();
            }).forEach(function(flag){
                if(flag == "novel"){
                    notes.push("Novel");
                    warn |= 4;
                }
                else if(flag.startsWith("STUTTER:")){
                    notes.push("Stutter-marked");
                    warn |= 4;
                }
                else
                    notes.push(flag);
            });
        }
        if(warn == 2 || warn & 4){
            cell.style.backgroundColor = "#ffe8c8";
        }
        cell.appendChild(document.createTextNode(notes.join(", ")));
    });
    var tabdiv = document.getElementById("tab" + i);
    removeChildren(tabdiv);
    if(table.rows.length > 1)
        tabdiv.appendChild(table);
    document.getElementById("saveTableLink").setAttribute("class", (autoSelected.length + userSelected.length? "" : "disabled"));
}

var pagehtml = "";
function savePage(){
    var link = document.getElementById("savePageLink");
    if(link.getAttribute("class") == "disabled")
        return false;

    //Get current settings and copy graph spec.
    var rendererName = document.querySelector("input[name=renderer]:checked").value;
    var splitMarkers = document.getElementById("splitmarkers").checked;
    var graph_specx = JSON.parse(JSON.stringify(graph_spec));
    for(i in graph_specx.signals)
        if(graph_specx.signals[i].name == "filter_marker"){
            graph_specx.signals[i].init = document.getElementById("markerFilter").value;
            break;
        }
    graph_specx.data[0].fdstools_filename = fileName;
    graph_specx.data[0].format = data_format;
    graph_specx.data[0].values = "";

    //Gather user-selected and user-deselected alleles.
    var sel = userSelected.slice();
    var desel = userDeselected.slice();
    selectedAlleles.forEach(function(sa){
        var i = sel.indexOf(sa);
        if(i < 0)
            sel.push(sa);
        else{
            sel.splice(i, 1);
            desel.push(sa);
        }
    });
    sel = sel.map(function(sa){
        var c = {};
        for(var prop in sa)
            c[prop] = sa[prop];
        c._prev = null;
        c._id = null;
        c.rank = null;
        c.thedatum = null;
        return c;
    });
    desel = desel.map(function(sa){
        var c = {};
        for(var prop in sa)
            c[prop] = sa[prop];
        c._prev = null;
        c._id = null;
        c.rank = null;
        c.thedatum = null;
        return c;
    });

    //Write page to Blob and offer it for download.
    var loadscript_pos = PAT_LOAD_SCRIPT.exec(pagehtml);
    var b = new Blob(
        [[pagehtml.substr(0, loadscript_pos.index + loadscript_pos[1].length),
        "<","script type=\"text/javascript\">",
        "var graph_spec=",JSON.stringify(graph_specx),
        ";onLoadSpec(false,true)",
        ";linebreak=",JSON.stringify(linebreak),
        ";data_values=",JSON.stringify(data_values),
        ";missing_markers=",JSON.stringify(missing_markers),
        ";userSelected=",JSON.stringify(sel),
        ";userDeselected=",JSON.stringify(desel),
        ";document.getElementById(\"splitmarkers\").checked=",(splitMarkers? "true": "false"),
        ";document.getElementById(\"commonrange\").disabled=",(splitMarkers? "true": "false"),
        ";document.getElementById(\"renderSVG\").checked=",(rendererName == "svg"? "true": "false"),
        ";document.getElementById(\"renderCanvas\").checked=",(rendererName == "canvas"? "true": "false"),
        ";parse(true);",
        "<","/script>",
        pagehtml.substr(loadscript_pos.index + loadscript_pos[1].length + loadscript_pos[2].length)].join("")],
        {type: "text/html"});
    if(window.navigator.msSaveOrOpenBlob)
        window.navigator.msSaveOrOpenBlob(b, fileName + ".html");
    else{
        var url = URL.createObjectURL(b);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName + ".html");
        link.click();
        link.setAttribute("href", "javascript:void(savePage())");
        link.removeAttribute("download");
    }
    if(b.msClose)
        b.msClose();
    return false;
}

function onLoadSpec(has_data, no_file_chooser){
    pagehtml = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
    if(!has_data && !no_file_chooser){
        //Handle files from the file input.
        document.getElementById("fileselect").addEventListener('change', function(){
            loadDataset(document.getElementById("fileselect").files);
        }, false);
        var rows = document.querySelectorAll(".fileselectrow");
        for (var i = 0; i < rows.length; i++)
            rows[i].style.display = "table-row";

        //Allow files to be dragged onto the page.
        document.addEventListener('dragover', function(evt){
            evt.stopPropagation();
            evt.preventDefault();
        }, false);
        document.addEventListener('drop', function(evt){
            evt.stopPropagation();
            evt.preventDefault();

            //Try to clear the currently displayed file, then try to set
            //the drag-'n-dropped file as the selected one on the file input.
            //Both actions are not supported in all major browsers.
            document.getElementById("fileselect").value = "";
            document.getElementById("fileselect").files = evt.dataTransfer.files;
            loadDataset(evt.dataTransfer.files);
        }, false);
    }

    //Doing allele calling outside of Vega.
    graph_spec.data[12].source = null;
    graph_spec.data[12].transform = null;

    //Parse data outside of Vega.
    data_format = graph_spec.data[0].format;
    graph_spec.data[0].format = null;
    if(has_data)
        data_values = vg.util.read(graph_spec.data[0].values, data_format).filter(function(datum){
            if(datum.sequence == "No data"){
                missing_markers.push(datum.marker);
                return false;
            }
            return true;
        });
    if(graph_spec.data[0].fdstools_filename && (has_data || no_file_chooser)){
        var rows = document.querySelectorAll(".filenamedisplayrow");
        for (var i = 0; i < rows.length; i++)
            rows[i].style.display = "table-row";
        var cell = document.getElementById("filenamedisplay");
        removeChildren(cell);
        cell.appendChild(document.createTextNode(graph_spec.data[0].fdstools_filename));
        setFileName(graph_spec.data[0].fdstools_filename);
    }

    //Update graph when rendering mode or axis scale is changed.
    document.getElementById("renderCanvas").addEventListener('change', function(){
        setRenderer(this.value);
    }, false);
    document.getElementById("renderSVG").addEventListener('change', function(){
        setRenderer(this.value);
    }, false);
    document.getElementById("scaleLinear").addEventListener('change', function(){
        setScale(this.value);
    }, false);
    document.getElementById("scaleLog").addEventListener('change', function(){
        setScale(this.value);
    }, false);
    document.getElementById("graphwidth").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("width", value);
    }, false);
    document.getElementById("barwidth").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("barwidth", value);
    }, false);
    document.getElementById("subgraphoffset").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("subgraphoffset", value);
    }, false);
    document.getElementById("maxseqlen").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("max_seq_len", value);
    }, false);
    document.getElementById("splitmarkers").addEventListener('change', function(){
        if(graphs !== false)
            parse(true);
        document.getElementById("commonrange").disabled = this.checked;
    }, false);
    document.getElementById("commonrange").addEventListener('change', function(){
        if(!graph_spec)
            return;
        graph_spec.marks[1].scales[0].domain.data = (this.checked? "table" : undefined);
        if(graphs !== false)
            parse(true);
    }, false);
    document.getElementById("minN").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("amplitude_threshold", value);
    }, false);
    document.getElementById("minP").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("amplitude_pct_threshold", value);
    }, false);
    document.getElementById("minT").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("amplitude_markerpct_threshold", value);
    }, false);
    document.getElementById("minO").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("orientation_threshold", value);
    }, false);
    document.getElementById("minNa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_amplitude_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("minPa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_amplitude_pct_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("minTa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_amplitude_markerpct_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("minCa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_correction_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("minAa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_recovery_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("minOa").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("allele_orientation_threshold", value);
        autoSelectAlleles();
    }, false);
    document.getElementById("markerFilter").addEventListener('change', function(){
        if(graphs !== false)
            parse(true);
    }, false);
    document.getElementById("minBias").addEventListener('change', function(){
        var value = parseFloat(this.value);
        if(isNaN(value))
            return;
        setSignalValue("bias_threshold", value);
    }, false);
    document.getElementById("shownegative").addEventListener('change', function(){
        setSignalValue("show_negative", this.checked);
    }, false);
    document.getElementById("filteruncorrected").addEventListener('change', function(){
        setSignalValue("filter_uncorrected", this.checked);
    }, false);
    document.getElementById("showother").addEventListener('change', function(){
        setSignalValue("show_other", this.checked);
    }, false);
    document.getElementById("sortstrbylength").addEventListener('change', function(){
        setSignalValue("sort_str_by_length", this.checked);
        updateAllTables();
    }, false);

    //Sync graph_spec and display.
    if(getScale() == "linear"){
        document.getElementById("scaleLinear").checked = true;
        document.getElementById("scaleLog").checked = false;
    }
    else{
        document.getElementById("scaleLinear").checked = false;
        document.getElementById("scaleLog").checked = true;
    }
    document.getElementById("markerFilter").value = getSignalValue("filter_marker");
    document.getElementById("graphwidth").value = getSignalValue("width");
    document.getElementById("barwidth").value = getSignalValue("barwidth");
    document.getElementById("subgraphoffset").value = getSignalValue("subgraphoffset");
    document.getElementById("maxseqlen").value = getSignalValue("max_seq_len");
    document.getElementById("minN").value = getSignalValue("amplitude_threshold");
    document.getElementById("minP").value = getSignalValue("amplitude_pct_threshold");
    document.getElementById("minT").value = getSignalValue("amplitude_markerpct_threshold");
    document.getElementById("minO").value = getSignalValue("orientation_threshold");
    document.getElementById("minNa").value = getSignalValue("allele_amplitude_threshold");
    document.getElementById("minPa").value = getSignalValue("allele_amplitude_pct_threshold");
    document.getElementById("minTa").value = getSignalValue("allele_amplitude_markerpct_threshold");
    document.getElementById("minCa").value = getSignalValue("allele_correction_threshold");
    document.getElementById("minAa").value = getSignalValue("allele_recovery_threshold");
    document.getElementById("minOa").value = getSignalValue("allele_orientation_threshold");
    document.getElementById("minBias").value = getSignalValue("bias_threshold");
    document.getElementById("shownegative").checked = getSignalValue("show_negative");
    document.getElementById("filteruncorrected").checked = getSignalValue("filter_uncorrected");
    document.getElementById("showother").checked = getSignalValue("show_other");
    document.getElementById("sortstrbylength").checked = getSignalValue("sort_str_by_length");
    document.getElementById("commonrange").checked = (graph_spec.marks[1].scales[0].domain.data == "table");

    //Automatically move the tooltip with the mouse pointer.
    var tt = document.getElementById("vis-tooltip");
    document.addEventListener('mousemove', function(e){
      if(e.clientX < document.documentElement.clientWidth / 2)
        tt.style.left = Math.max(0, Math.min(document.documentElement.clientWidth - tt.offsetWidth, e.clientX + 10)) + "px";
      else
        tt.style.left = Math.max(0, e.clientX - tt.offsetWidth - 10) + "px";
      if(e.clientY + 10 + tt.offsetHeight > document.documentElement.clientHeight)
        tt.style.top = (document.documentElement.clientHeight - tt.offsetHeight) + "px";
      else
        tt.style.top = (e.clientY + 10) + "px";
    }, false);

    setMessage("Ready", false);
    if(has_data)
        parse();
}
</script>
<!-- BEGIN_LOAD_SCRIPT -->
<script type="text/javascript">
var graph_spec = false;
setMessage("Loading graph specification...", false);
vg.util.load({url: "samplevis.json"}, function(err, result){
    graph_spec = JSON.parse(result);
    onLoadSpec(false);
});
</script>
<!-- END_LOAD_SCRIPT -->
</body>
</html>