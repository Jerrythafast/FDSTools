<!DOCTYPE html>
<html>
<head>
    <!--
    # Copyright (C) 2016 Jerry Hoogenboom
    #
    # This file is part of FDSTools, data analysis tools for Next
    # Generation Sequencing of forensic DNA markers.
    #
    # FDSTools is free software: you can redistribute it and/or modify it
    # under the terms of the GNU General Public License as published by the
    # Free Software Foundation, either version 3 of the License, or (at
    # your option) any later version.
    #
    # FDSTools is distributed in the hope that it will be useful, but
    # WITHOUT ANY WARRANTY; without even the implied warranty of
    # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    # General Public License for more details.
    #
    # You should have received a copy of the GNU General Public License
    # along with FDSTools.  If not, see <http://www.gnu.org/licenses/>.
    -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Allele Visualisation - FDSTools</title>
    <!-- VERSION 1.0.0beta2 -->
    <!-- BEGIN_LIBRARIES -->
    <script src="https://vega.github.io/vega-editor/vendor/d3.min.js"></script>
    <script src="https://vega.github.io/vega/vega.min.js"></script>
    <!-- END_LIBRARIES -->
    <style>
        * {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 10pt;
        }
        body {
            margin: 0px;
        }
        div.options {
            position: absolute;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
        }
        table.optiongroup {
            padding: 10px 0px 0px 0px;
            margin: 0px;
            border-spacing: 0px;
            border: none;
        }
        table.optiongroup td {
            padding-right: 10px;
        }
        table.optiongroup th {
            text-align: left;
            font-weight: bold;
            padding-top: 5px;
        }
        .description {
            max-width: 250px;
            text-align: justify;
        }
        .description p:first-child{
            margin-top: 0px;
        }
        .description p:last-child{
            margin-bottom: 0px;
        }
        #optionsheader {
            cursor: pointer;
            font-variant: small-caps;
            border-bottom: 1px dashed black;
        }
        div#vis {
            position: absolute;
            overflow: auto;
            bottom: 0px;
            top: 0px;
            right: 0px;
            left: 0px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="options">
        <strong id="optionsheader">Options</strong><br>
        <div id="options">
            <table class="optiongroup" id="fileselectgroup" style="display: none">
                <tr>
                    <th>Input file</th>
                </tr>
                <tr>
                    <td>Allele list file:</td>
                </tr>
                <tr>
                    <td><input id="fileselect" type="file"></td>
                </tr>
                <tr>
                    <td>(or drag a file onto this page)</td>
                </tr>
            </table>
            <table class="optiongroup description">
                <tr>
                    <th>Description</th>
                </tr>
                <tr>
                    <td>
                        <p>
                        The graph depicts every allele among the reference
                        samples as a circle. The size of the circle corresponds
                        to the number of samples with that particular allele. A
                        black inner circle depicts the number of homozygotes.
                        </p>
                        <p>
                        The circles of two alleles are connected by a line
                        whenever samples exist that have a combination of the
                        two connected alleles. The thickness of the line
                        corresponds to the number of heterozygotes with that
                        particular combination of alleles.
                        </p>
                    </td>
                </tr>
            </table>
            <table class="optiongroup">
                <tr>
                    <th colspan="3">Display options</th>
                </tr>
                <tr>
                    <td>Graph width</td>
                    <td colspan="2"><input type="text" value="600" id="graphwidth" size="3"> px</td>
                </tr>
                <tr>
                    <td>Graph height</td>
                    <td colspan="2"><input type="text" value="500" id="graphheight" size="3"> px</td>
                </tr>
                <tr>
                    <td>Renderer</td>
                    <td><input type="radio" name="renderer" value="svg" id="renderSVG" checked> SVG</td>
                    <td><input type="radio" name="renderer" value="canvas" id="renderCanvas"> Canvas</td>
                </tr>
            </table>
            <a id="saveLink" href="javascript:void(saveImage())" style="display: none">Save image</a>
        </div>
    </div>
    <div id="vis"></div>
    <script type="text/javascript">
        var graph = false;
        var fileName = "graph";
        var stamp = 0;
        function parse(){
            var this_stamp = ++stamp;
            vg.parse.spec(graph_spec, function(chart){
                //Cancel rendering if a new parse() call was made.
                if(this_stamp != stamp)
                    return;

                var visdiv = document.getElementById("vis");
                graph = chart({el: visdiv, renderer: document.querySelector("input[name=renderer]:checked").value});
                graph.update();
                document.getElementById("saveLink").style.display = "inline";

                //Scroll to the right; the graph is more interesting than the long labels.
                visdiv.scrollLeft = visdiv.scrollWidth;
            });
        }

        function setSignalValue(signalname, value){
            if(!graph_spec)
                return;
            var visdiv = document.getElementById("vis");
            var scrollRight = (visdiv.scrollLeft >= visdiv.scrollWidth - visdiv.clientWidth);
            if(signalname == "width")
                graph_spec.width = value;
            if(signalname == "height")
                graph_spec.height = value;
            for(i in graph_spec.signals){
                if(graph_spec.signals[i].name == signalname){
                    graph_spec.signals[i].init = value;
                    break;
                }
            }
            if(graph)
                graph.signal(signalname, value).padding("auto").update();
            if(scrollRight)
                visdiv.scrollLeft = visdiv.scrollWidth;
            return;
        }

        function getSignalValue(signalname){
            if(!graph_spec)
                return false;
            if(signalname == "width")
                return graph_spec.width;
            if(signalname == "height")
                return graph_spec.height;
            for(i in graph_spec.signals)
                if(graph_spec.signals[i].name == signalname)
                    return graph_spec.signals[i].init;
            return false;
        }

        function setRenderer(value){
            if(graph)
                graph.renderer(value).update();
        }

        function setFileName(value){
            if(!value)
                value = "graph";
            fileName = value;
            if(value == "graph")
                document.title = "Allele Visualisation - FDSTools";
            else
                document.title = value + " - Allele Visualisation - FDSTools";
        }

        //Load the data (input is a fileList object; only the first file is loaded).
        var currentlyLoadedFile = "no/file/loaded";
        function loadDataset(fileList){
            if(!graph_spec || !fileList || !fileList.length || fileList[0].name == currentlyLoadedFile)
                return;
            currentlyLoadedFile = fileList[0].name;
            var reader = new FileReader();
            reader.onload = function(e){
                if(fileList && fileList.length && fileList[0].name)
                    setFileName(fileList[0].name.substr(0, fileList[0].name.lastIndexOf(".")));
                else
                    setFileName(false);
                graph_spec.data[0].values = reader.result;
                parse();
            };
            reader.readAsText(fileList[0]);
        }

        //Save image function.
        function saveImage(){
            var imageType = document.getElementById("renderSVG").checked? "svg": "png";
            if(window.navigator.msSaveOrOpenBlob){
                //Internet Explorer has its own ways of doing things.
                var b;
                if(imageType == "svg")
                    b = new Blob([graph._el.innerHTML], {type: "image/svg+xml;charset=utf-8"});
                else
                    b = graph._el.firstChild.msToBlob();
                window.navigator.msSaveOrOpenBlob(b, fileName + "." + imageType);
                if(b.msClose)
                    b.msClose();
            }
            else{
                var link = document.getElementById("saveLink");
                link.setAttribute("href", graph.toImageURL(imageType));
                link.setAttribute("download", fileName + "." + imageType);
                link.click();
                link.setAttribute("href", "javascript:void(saveImage())");
                link.removeAttribute("download");
            }
            return false;
        }

        function onLoadSpec(has_data){
            if(!has_data){
                //Handle files from the file input.
                document.getElementById("fileselect").addEventListener('change', function(){
                    loadDataset(document.getElementById("fileselect").files);
                }, false);
                document.getElementById("fileselectgroup").style.display = "table";

                //Allow files to be dragged onto the page.
                document.addEventListener('dragover', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();
                }, false);
                document.addEventListener('drop', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();

                    //Try to clear the currently displayed file, then try to set
                    //the drag-'n-dropped file as the selected one on the file input.
                    //Both actions are not supported in all major browsers.
                    document.getElementById("fileselect").value = "";
                    document.getElementById("fileselect").files = evt.dataTransfer.files;
                    loadDataset(evt.dataTransfer.files);
                }, false);
            }
            else if(graph_spec.data[0].fdstools_filename)
                setFileName(graph_spec.data[0].fdstools_filename);

            //Update graph when rendering mode or axis scale is changed.
            document.getElementById("renderCanvas").addEventListener('change', function(){
                setRenderer(this.value);
            }, false);
            document.getElementById("renderSVG").addEventListener('change', function(){
                setRenderer(this.value);
            }, false);
            document.getElementById("graphwidth").addEventListener('change', function(){
                var value = parseFloat(this.value);
                if(isNaN(value))
                    return;
                setSignalValue("width", value);
            }, false);
            document.getElementById("graphheight").addEventListener('change', function(){
                var value = parseFloat(this.value);
                if(isNaN(value))
                    return;
                setSignalValue("height", value);
            }, false);

            //Toggle options visibility.
            document.getElementById("optionsheader").addEventListener('click', function(){
                var opts = document.getElementById("options");
                if(opts.style.display == "none")
                    document.getElementById("options").style.display = "block";
                else
                    document.getElementById("options").style.display = "none";
            }, false);

            //Sync graph_spec and display.
            document.getElementById("graphwidth").value = getSignalValue("width");
            document.getElementById("graphheight").value = getSignalValue("height");
            if(has_data){
                document.getElementById("options").style.display = "none";
                parse();
            }
        }
    </script>
    <!-- BEGIN_LOAD_SCRIPT -->
    <script type="text/javascript">
        var graph_spec = false;
        vg.util.load({url: "allelevis.json"}, function(err, result){
            graph_spec = JSON.parse(result);
            onLoadSpec(false);
        });
    </script>
    <!-- END_LOAD_SCRIPT -->
</body>
</html>
