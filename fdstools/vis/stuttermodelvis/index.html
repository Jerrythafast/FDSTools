<!DOCTYPE html>
<html>
<head>
    <!--
    # Copyright (C) 2016 Jerry Hoogenboom
    #
    # This file is part of FDSTools, data analysis tools for Next
    # Generation Sequencing of forensic DNA markers.
    #
    # FDSTools is free software: you can redistribute it and/or modify it
    # under the terms of the GNU General Public License as published by the
    # Free Software Foundation, either version 3 of the License, or (at
    # your option) any later version.
    #
    # FDSTools is distributed in the hope that it will be useful, but
    # WITHOUT ANY WARRANTY; without even the implied warranty of
    # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    # General Public License for more details.
    #
    # You should have received a copy of the GNU General Public License
    # along with FDSTools.  If not, see <http://www.gnu.org/licenses/>.
    -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Stutter Model Visualisation - FDSTools</title>
    <!-- VERSION 1.0.0beta2 -->
    <!-- BEGIN_LIBRARIES -->
    <script src="https://vega.github.io/vega-editor/vendor/d3.min.js"></script>
    <script src="https://vega.github.io/vega/vega.min.js"></script>
    <!-- END_LIBRARIES -->
    <style>
        * {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 10pt;
        }
        body {
            margin: 0px;
        }
        div.options {
            position: absolute;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
        }
        div.options span.help {
            cursor: help;
            font-weight: bold;
            border-bottom: 1px dashed black;
        }
        table.optiongroup {
            padding: 10px 0px 0px 0px;
            margin: 0px;
            border-spacing: 0px;
            border: none;
        }
        table.optiongroup td {
            padding-right: 10px;
        }
        table.optiongroup th {
            text-align: left;
            font-weight: bold;
            padding-top: 5px;
        }
        #optionsheader {
            cursor: pointer;
            font-variant: small-caps;
            border-bottom: 1px dashed black;
        }
        div#vis {
            position: absolute;
            overflow: auto;
            bottom: 0px;
            top: 0px;
            right: 0px;
            left: 0px;
            text-align: right;
        }
        input[type=range]::-moz-range-track {
            background-image: linear-gradient(to right, #eee, #000);
            border: 1px solid black;
            height: 11px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background-image: linear-gradient(to right, #eee, #000);
            border: 1px solid black;
            height: 11px;
        }
        input[type=range]::-webkit-slider-thumb {
            margin-top: -6px;
        }
        input[type=range]::-ms-track {
            background-image: linear-gradient(to right, #eee, #000);
            border: 1px solid black;
            height: 11px;
        }
        input[type=range]::-ms-fill-lower, input[type=range]::-ms-fill-upper {
            background: transparent;
        }
        input[type=range] {
            margin: 0px;
            padding: 0px;
            width: 150px;
        }
        td.jitterleft {
           text-align: right;
        }
        td.jittermiddle {
           text-align: center;
        }
        td.jitterleft {
           text-align: left;
        }
    </style>
</head>
<body>
    <div class="options">
        <strong id="optionsheader">Options</strong><br>
        <div id="options">
            <table class="optiongroup" id="fileselectgroup" style="display: none">
                <tr>
                    <th>Input file</th>
                </tr>
                <tr>
                    <td>Stutter model file:</td>
                </tr>
                <tr>
                    <td><input id="fileselect" type="file"></td>
                </tr>
                <tr>
                    <td>(or drag a file onto this page)</td>
                </tr>
            </table>
            <table class="optiongroup">
                <tr>
                    <th colspan="4">Raw data points</th>
                </tr>
                <tr>
                    <td colspan="4">Raw data points file:</td>
                </tr>
                <tr>
                    <td colspan="4"><input id="fileselect2" type="file"></td>
                </tr>
                <tr>
                    <td>Jitter</td>
                    <td class="jitterleft">Low</td>
                    <td class="jittermiddle"><input type="range" min="0" max="100" value="25" step="any" id="jitter"></td>
                    <td class="jitterright">High</td>
                </tr>
            </table>
            <table class="optiongroup">
                <tr>
                    <th colspan="2">Filtering options</th>
                </tr>
                <tr>
                    <td>Repeat unit</td>
                    <td>
                        <input type="text" id="unitFilter" size="20">
                        <span class="help" title="Type AG to show all repeat units containing 'AG'. Type =AG to show the 'AG' repeat unit only. Separate multiple values with spaces.">?</span>
                    </td>
                </tr><!--
                <tr>
                    <td>Stutter amount</td>
                    <td><input type="text" value="" id="foldFilter" size="3"></td>
                </tr>-->
                <tr>
                    <td>Marker name</td>
                    <td>
                        <input type="text" id="markerFilter" size="20">
                        <span class="help" title="Type xyz to show all markers with 'xyz' in their names. Type =xyz to show only the marker 'xyz'. Separate multiple values with spaces.">?</span>
                    </td>
                </tr>
                <tr>
                    <td>Fit to all data</td>
                    <td><input type="checkbox" id="allDataFilter" checked> show</td>
                </tr>
            </table>
            <table class="optiongroup">
                <tr>
                    <th colspan="3">Display options</th>
                </tr>
                <tr>
                    <td>Graph dimensions</td>
                    <td colspan="2"><input type="text" value="600" id="graphwidth" size="3"> x <input type="text" value="400" id="graphheight" size="3"> px</td>
                </tr>
                <tr>
                    <td>Subgraph spacing</td>
                    <td colspan="2"><input type="text" value="70" id="subgraphoffset" size="3"> px</td>
                </tr>
                <tr>
                    <td>Renderer</td>
                    <td><input type="radio" name="renderer" value="svg" id="renderSVG" checked> SVG</td>
                    <td><input type="radio" name="renderer" value="canvas" id="renderCanvas"> Canvas</td>
                </tr>
            </table>
            <a id="saveLink" href="javascript:void(saveImage())" style="display: none">Save image</a>
        </div>
    </div>
    <div id="vis"></div>
    <script type="text/javascript">
        var graph = false;
        var fileName = "graph";
        var stamp = 0;
        function parse(){
            var this_stamp = ++stamp;
            vg.parse.spec(graph_spec, function(chart){
                //Cancel rendering if a new parse() call was made.
                if(this_stamp != stamp)
                    return;

                var visdiv = document.getElementById("vis");
                graph = chart({el: visdiv, renderer: document.querySelector("input[name=renderer]:checked").value});
                graph.update();
                document.getElementById("saveLink").style.display = "inline";

                //Scroll to the right; the graph is more interesting than the long labels.
                visdiv.scrollLeft = visdiv.scrollWidth;
            });
        }

        function compileFilter(filter){
            return new RegExp('(?:' + filter.replace(/(^| )=(.*?)(?= |$)/g, '$1^$2$$').replace(/ +/g, ')|(?:') + ')')
        }

        function setSignalValue(signalname, value){
            if(!graph_spec)
                return;
            var visdiv = document.getElementById("vis");
            var scrollRight = (visdiv.scrollLeft >= visdiv.scrollWidth - visdiv.clientWidth);
            if(signalname == "width")
                graph_spec.width = value;
            for(i in graph_spec.signals){
                if(graph_spec.signals[i].name == signalname){
                    graph_spec.signals[i].init = value;
                    break;
                }
            }
            if(graph)
                graph.signal(signalname, value).padding("auto").update();
            if(scrollRight)
                visdiv.scrollLeft = visdiv.scrollWidth;
            return;
        }

        function getSignalValue(signalname){
            if(!graph_spec)
                return false;
            if(signalname == "width")
                return graph_spec.width;
            for(i in graph_spec.signals)
                if(graph_spec.signals[i].name == signalname)
                    return graph_spec.signals[i].init;
            return false;
        }

        function setRenderer(value){
            if(graph)
                graph.renderer(value).update();
        }

        function setFileName(value){
            if(!value)
                value = "graph";
            fileName = value;
            if(value == "graph")
                document.title = "Stutter Model Visualisation - FDSTools";
            else
                document.title = value + " - Stutter Model Visualisation - FDSTools";
        }

        var currentlyLoadedFitFunctionsFile = "no/file/loaded";
        function loadFitFunctions(filename, data){
            if(filename == currentlyLoadedFitFunctionsFile)
                return false;
            if(filename)
                setFileName(filename.substr(0, filename.lastIndexOf(".")));
            else
                setFileName(false);
            graph_spec.data[0].values = data;
            return true;
        }
        var currentlyLoadedRawDataFile = "no/file/loaded";
        function loadRawData(filename, data){
            if(filename == currentlyLoadedRawDataFile)
                return false;
            graph_spec.data[1].values = data;
            return !!graph;
        }
        function setSelectedFiles(input, fileList){
            //Try to clear the currently displayed file, then try to set
            //the drag-'n-dropped file as the selected one on the file input.
            //Both actions are not supported in all major browsers.
            input.value = "";
            input.files = fileList;
        }

        //Input is a fileList object; only the first file is loaded.
        function loadFile(fileList, setInput){
            if(!graph_spec || !fileList || !fileList.length)
                return;
            var reader = new FileReader();
            reader.onload = function(e){
                var success;
                var cols = reader.result.substr(0, reader.result.indexOf("\n")).split("\t");
                if(Math.min(cols.indexOf("length"), cols.indexOf("forward"), cols.indexOf("reverse")) == -1){
                    //This is a file with fit functions.
                    success = loadFitFunctions(fileList[0].name, reader.result);
                    if(setInput)
                        setSelectedFiles(document.getElementById("fileselect"), fileList);
                }
                else{
                    //This is a file with raw data points.
                    success = loadRawData(fileList[0].name, reader.result);
                    if(setInput)
                        setSelectedFiles(document.getElementById("fileselect2"), fileList);
                }
                if(success)
                    parse();
            };
            reader.readAsText(fileList[0]);
        }

        //Save image function.
        function saveImage(){
            var imageType = document.getElementById("renderSVG").checked? "svg": "png";
            if(window.navigator.msSaveOrOpenBlob){
                //Internet Explorer has its own ways of doing things.
                var b;
                if(imageType == "svg")
                    b = new Blob([graph._el.innerHTML], {type: "image/svg+xml;charset=utf-8"});
                else
                    b = graph._el.firstChild.msToBlob();
                window.navigator.msSaveOrOpenBlob(b, fileName + "." + imageType);
                if(b.msClose)
                    b.msClose();
            }
            else{
                var link = document.getElementById("saveLink");
                link.setAttribute("href", graph.toImageURL(imageType));
                link.setAttribute("download", fileName + "." + imageType);
                link.click();
                link.setAttribute("href", "javascript:void(saveImage())");
                link.removeAttribute("download");
            }
            return false;
        }

        function onLoadSpec(has_data){
            if(!has_data){
                //Handle files from the file input.
                document.getElementById("fileselect").addEventListener('change', function(){
                    loadFile(document.getElementById("fileselect").files);
                }, false);
                document.getElementById("fileselectgroup").style.display = "table";

                //Allow files to be dragged onto the page.
                document.addEventListener('dragover', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();
                }, false);
                document.addEventListener('drop', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();
                    loadFile(evt.dataTransfer.files, true);
                }, false);
            }
            else if(graph_spec.data[0].fdstools_filename)
                setFileName(graph_spec.data[0].fdstools_filename);

            //Update graph when rendering mode is changed.
            document.getElementById("renderCanvas").addEventListener('change', function(){
                setRenderer(this.value);
            }, false);
            document.getElementById("renderSVG").addEventListener('change', function(){
                setRenderer(this.value);
            }, false);
            document.getElementById("graphwidth").addEventListener('change', function(){
                var value = parseFloat(this.value);
                if(isNaN(value))
                    return;
                setSignalValue("width", value);
            }, false);
            document.getElementById("graphheight").addEventListener('change', function(){
                var value = parseFloat(this.value);
                if(isNaN(value))
                    return;
                setSignalValue("graphheight", value);
            }, false);
            document.getElementById("subgraphoffset").addEventListener('change', function(){
                var value = parseFloat(this.value);
                if(isNaN(value))
                    return;
                setSignalValue("subgraphoffset", value);
            }, false);
            document.getElementById("unitFilter").addEventListener('change', function(){
                var value = this.value;
                try{
                    compileFilter(value.trim());
                }
                catch(e){
                    value = "=";
                }
                setSignalValue("filter_unit", value);
            }, false);
            document.getElementById("markerFilter").addEventListener('change', function(){
                var value = this.value;
                try{
                    compileFilter(value.trim());
                }
                catch(e){
                    value = "=";
                }
                setSignalValue("filter_marker", value);
            }, false);
            document.getElementById("allDataFilter").addEventListener('change', function(){
                setSignalValue("show_all_data", this.checked);
            }, false);
            document.getElementById("fileselect2").addEventListener('change', function(){
                loadFile(document.getElementById("fileselect2").files);
            }, false);
            document.getElementById("jitter").addEventListener('mouseup', function(){
                var value = parseFloat(this.value)/100;
                if(isNaN(value) || value == getSignalValue("jitter"))
                    return;
                console.log(value);
                setSignalValue("jitter", value);
            }, false);
            document.getElementById("jitter").addEventListener('keyup', function(){
                var value = parseFloat(this.value)/100;
                if(isNaN(value) || value == getSignalValue("jitter"))
                    return;
                console.log(value);
                setSignalValue("jitter", value);
            }, false);

            //Toggle options visibility.
            document.getElementById("optionsheader").addEventListener('click', function(){
                var opts = document.getElementById("options");
                if(opts.style.display == "none")
                    document.getElementById("options").style.display = "block";
                else
                    document.getElementById("options").style.display = "none";
            }, false);

            //Sync graph_spec and display.
            document.getElementById("unitFilter").value = getSignalValue("filter_unit");
            document.getElementById("markerFilter").value = getSignalValue("filter_marker");
            document.getElementById("allDataFilter").checked = getSignalValue("show_all_data");
            document.getElementById("graphwidth").value = getSignalValue("width");
            document.getElementById("graphheight").value = getSignalValue("graphheight");
            document.getElementById("subgraphoffset").value = getSignalValue("subgraphoffset");
            document.getElementById("jitter").value = getSignalValue("jitter")*100;
            if(has_data){
                document.getElementById("options").style.display = "none";
                parse();
            }
        }
    </script>
    <!-- BEGIN_LOAD_SCRIPT -->
    <script type="text/javascript">
        var graph_spec = false;
        vg.util.load({url: "stuttermodelvis.json"}, function(err, result){
            graph_spec = JSON.parse(result);
            onLoadSpec(false);
        });
    </script>
    <!-- END_LOAD_SCRIPT -->
</body>
</html>
